name: Deploy to VM

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Deploy directly on VM
        run: |
          set -e

          echo "Navigating to project folder..."
          cd /home/ubuntu/vincentio-react

          echo "Pulling latest code..."
          git fetch --all
          git reset --hard origin/main

          echo "Building Docker image..."
          docker build -t vincentio-react .

          echo "Stopping old container if exists..."
          if [ "$(docker ps -q -f name=vincentio-react-app)" ]; then
            docker stop vincentio-react-app
            docker rm vincentio-react-app
          fi

          echo "Starting container..."
          docker run -d -p 80:80 --name vincentio-react-app vincentio-react

          echo "Deployment successful!"
